name: Auto-approve validated PRs

# ESPERA a que karate-testrail.yml termine primero
on:
  workflow_run:
    workflows: ["Karate ‚Üí TestRail (Config-Driven)"]
    types: [completed]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    # Solo aprobar si el workflow anterior fue exitoso
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: "Find and approve PR"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get the triggering workflow run
            const workflowRun = context.payload.workflow_run;
            const branch = workflowRun.head_branch;
            
            console.log(`üîç Looking for PR on branch: ${branch}`);
            
            // Find the PR associated with this workflow run
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branch}`
            });
            
            if (pullRequests.length === 0) {
              console.log('‚ö†Ô∏è No PR encontrado para esta rama');
              return;
            }
            
            const pr = pullRequests[0];
            const prNumber = pr.number;
            
            console.log(`‚úì PR #${prNumber} encontrado`);
            
            if (pr.draft) {
              console.log('‚è≠Ô∏è PR est√° en draft - no se aprueba');
              return;
            }
            
            // Check if already approved by us
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const botApproved = reviews.some(review => 
              review.state === 'APPROVED' && review.user.type === 'Bot'
            );
            
            if (botApproved) {
              console.log('‚úì PR ya fue aprobado por el bot');
              return;
            }
            
            // Crear aprobaci√≥n
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: '‚úÖ **Aprobado autom√°ticamente**\n\nüîß Pipeline **`Karate ‚Üí TestRail`** ejecutado exitosamente\n\n‚úì Todos los checks pasaron\n‚úì Listo para mergear'
              });
              
              console.log(`‚úì PR #${prNumber} aprobado autom√°ticamente`);
            } catch (error) {
              console.error(`‚ùå Error al aprobar PR: ${error.message}`);
              throw error;
            }
