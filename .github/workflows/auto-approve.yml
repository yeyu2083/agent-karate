name: Auto-approve validated PRs

# ESPERA a que karate-testrail.yml termine primero
on:
  workflow_run:
    workflows: ["Karate ‚Üí TestRail (Config-Driven)"]
    types: [completed]

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    # Solo aprobar si el workflow anterior fue exitoso y el PR no est√° en draft
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: "Get PR info"
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: context.payload.workflow_run.head_branch
            });
            
            if (pullRequests.length > 0) {
              console.log('‚úì PR encontrado');
              console.log(`PR Number: ${pullRequests[0].number}`);
              return pullRequests[0].number;
            } else {
              console.log('‚ö†Ô∏è No PR encontrado para esta rama');
              return null;
            }
      
      - name: "Auto-approve PR"
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: '${{ github.event.workflow_run.head_branch }}'
            });
            
            if (prs.data.length === 0) {
              console.log('‚ö†Ô∏è No PR encontrado');
              return;
            }
            
            const pr = prs.data[0];
            
            if (pr.draft) {
              console.log('‚è≠Ô∏è  PR en draft - no se aprueba');
              return;
            }
            
            // Crear aprobaci√≥n
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event: 'APPROVE',
              body: '‚úÖ **Aprobado autom√°ticamente**\n\nüîß Pipeline de tests **`Karate ‚Üí TestRail`** ejecutado exitosamente\n\n‚úì Todos los checks pasaron\n‚úì Listo para mergear'
            });
            
            console.log(`‚úì PR #${pr.number} aprobado autom√°ticamente`);
